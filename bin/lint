#!/usr/bin/env sh

set -eu

cd "$(pwd -P)"

bindir=$( cd "${0%/*}" && pwd )
rootdir=$( cd "$bindir"/.. && pwd )
devcontainerdir=$( cd "$bindir"/../.devcontainer && pwd )
targetbin=$rootdir/target/bin

cd "$rootdir"

exe=
if [ "$(uname -s)" = Darwin ]; then
  # Darwin's uname doesn't support the -o flag so we short circuit here.
  :;
elif [ "$(uname -o)" = Msys ]; then
  exe=.exe
fi

lintversion=$(sed -nE 's/^ARG GOLANGCI_LINT=([^ ]+)/\1/p' .devcontainer/Dockerfile)
lintbin=$targetbin/.golangci-lint-$lintversion$exe

if [ ! -f "$lintbin" ]; then
  mkdir -p "$targetbin"
  "$bindir"/scurl https://raw.githubusercontent.com/golangci/golangci-lint/v$lintversion/install.sh | sh -s -- -b . v$lintversion
  mv ./golangci-lint$exe "$lintbin"
fi

"$lintbin" run "$@"
