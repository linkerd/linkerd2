name: ARM64 integration tests
description: Runs the deep integration tests on self-hosted ARM64 runner

inputs:
  tag:
    required: true
  docker-registry:
    required: true
  k3d-version:
    required: true

runs:
  using: composite
  steps:
    - uses: actions/setup-go@c4a742cab115ed795e34d4513e2cf7d472deb55f
      with:
        go-version: '1.18'
    - uses: docker/setup-buildx-action@94ab11c41e45d028884a99163086648e898eed25
    - shell: bash
      run: |
        bin/docker-pull-binaries "${{ inputs.tag }}"
        CMD="$PWD/target/release/linkerd2-cli-${{ inputs.tag}}-linux-arm64"
        echo "CMD=$CMD" >> "$GITHUB_ENV"
        "$CMD" version --client
    - uses: azure/setup-kubectl@7f7e5ba5ea3e491b92e6e8e5819963f8f3a1f076
    - shell: bash
      env:
        TAG: ${{ inputs.tag }}
        RUN_ARM_TEST: 1
        LINKERD_DOCKER_REGISTRY: ${{ inputs.docker-registry }}
      run: bin/tests --name deep --images preload "$CMD"
    - shell: bash
      run: bin/k3d cluster delete --all
      if: always()
