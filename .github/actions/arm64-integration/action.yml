name: ARM64 integration tests
description: Runs the deep integration tests on self-hosted ARM64 runner

inputs:
  tag:
    required: true
  docker-registry:
    required: true
  k3d-version:
    required: true

runs:
  using: composite
  steps:
    - uses: actions/checkout@93ea575cb5d8a053eaa0ac8fa3b40d7e05a33cc8
    - uses: actions/setup-go@c4a742cab115ed795e34d4513e2cf7d472deb55f
      with:
        go-version: '1.18'
    - uses: docker/setup-buildx-action@94ab11c41e45d028884a99163086648e898eed25
    - shell: bash
      run: |
        bin/docker-pull-binaries "${{ inputs.tag }}"
        CMD="$PWD/target/release/linkerd2-cli-${{ inputs.tag }}-linux-arm64"
        echo "CMD=$CMD" >> "$GITHUB_ENV"
        "$CMD" version --client
    - uses: extractions/setup-just@95b912dc5d3ed106a72907f2f9b91e76d60bdb76
    - uses: azure/setup-kubectl@7f7e5ba5ea3e491b92e6e8e5819963f8f3a1f076
    - name: Setup k3d
      shell: bash
      run: |
        mkdir -p $PWD/target/bin
        PATH=$PATH:$PWD/target/bin
        echo "PATH=$PATH" >> "$GITHUB_ENV"
        bin/scurl -v "https://raw.githubusercontent.com/k3d-io/k3d/${{ inputs.k3d-version }}/install.sh" \
          | USE_SUDO=false K3D_INSTALL_DIR=$PWD/target/bin bash
    - name: Cluster setup
      shell: bash
      run: |
       CLUSTER_NAME=$(printf "${{ github.ref_name }}" | tr -c [:alnum:] -)
       echo "CLUSTER_NAME=$CLUSTER_NAME" >> "$GITHUB_ENV"
       just k3d-name=$CLUSTER_NAME k3d-create
       just k3d-name=$CLUSTER_NAME k3d-use
    - shell: bash
      env:
        TAG: ${{ inputs.tag }}
        RUN_ARM_TEST: 1
        LINKERD_DOCKER_REGISTRY: ${{ inputs.docker-registry }}
      run: go test ./test/integration/deep/... --integration-tests --linkerd $CMD
    - shell: bash
      run: just k3d-name=$CLUSTER_NAME k3d-delete
      if: always()
