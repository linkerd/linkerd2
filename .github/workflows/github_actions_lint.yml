name: Lint Workflows

on:
  pull_request:
    paths:
      - .github/**
      - .devcontainer/devcontainer.json

permissions:
  contents: read

jobs:
  lint-workflows:
    runs-on: ubuntu-20.04
    name: Lint GitHub Actions
    timeout-minutes: 30
    container
      image: ghcr.io/linkerd/dev:v18
      options: --user root
    steps:
      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b
      - name: Run actionlint
        shell: bash
        run: |
          # Run actionlint and format errors to fit GitHub Action's style
          # To print multiline text in annotations toolkit, we replace '\n'
          # with '%0A' (urlencoded newline, see https://github.com/actions/toolkit/issues/193)
          # Shellcheck 2016 is supressed so template args can be passed in
          # Shellcheck 1090 is supressed to avoid using location directives when sourcing scripts
          actionlint -format '{{range $err := .}}::error file={{$err.Filepath}},line={{$err.Line}},col={{$err.Column}}::{{$err.Message}}%0A```%0A{{replace $err.Snippet "\\n" "%0A"}}%0A```\n{{end}}' -ignore 'SC2016:' -ignore 'SC1090:'

  devcontainer-versions:
    runs-on: ubuntu-latest
    name: Check devcontainer versions
    container:
      image: ghcr.io/linkerd/dev:v18
      options: --user root
    steps:
      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b
      - name: Scan workflows for other Devcontainer image versions
        run: |
          # Strip jsonc comments because `jq` doesn't support them.
          image=$(sed -E '/^\s*\/\/.*/d' .devcontainer/devcontainer.json |jq -Mr .image)
          for f in .github/workflows/* ; do
            for i in $(yq '.jobs.*.container | .image // "" | match("ghcr.io/linkerd/dev:.*").string' < $f) ; do
              if [ "$i" != "$image" ]; then
                echo "::error file=$f::Workflow '$f' uses incorrect Devcontainer image '$i'"
                exit 1
              fi
            done
          done


