# kube-prometheus-stack configuration for load testing
# Minimal monitoring stack optimized for observing load tests

prometheus:
  prometheusSpec:
    # Allow all ServiceMonitors/PodMonitors regardless of labels
    podMonitorSelectorNilUsesHelmValues: false
    probeSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    serviceMonitorSelectorNilUsesHelmValues: false
    
    enableRemoteWriteReceiver: true
    retention: 24h
    retentionSize: 2GiB
    
    storageSpec:
      emptyDir:
        medium: Memory
        sizeLimit: 2Gi
    
    # Schedule on control plane nodes if available
    affinity:
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
                - key: node-role.kubernetes.io/control-plane
                  operator: Exists
    
    resources:
      requests:
        memory: 1Gi
        cpu: 250m
      limits:
        memory: 2Gi
        cpu: 1000m
    
    # Scrape Linkerd control plane metrics
    additionalScrapeConfigs:
      - job_name: linkerd-controller
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - linkerd
                - linkerd-viz
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: admin-http
          - source_labels: [__meta_kubernetes_pod_container_name]
            action: replace
            target_label: component
      
      # Scrape destination load test controllers
      - job_name: dst-load-controller
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - dst-test
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_component]
            action: keep
            regex: (client|churn)
          - source_labels: [__meta_kubernetes_pod_container_port_name]
            action: keep
            regex: admin-http
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_component]
            action: replace
            target_label: component

grafana:
  enabled: true
  adminPassword: admin
  
  persistence:
    enabled: true
    type: pvc
    storageClassName: local-path
    accessModes: [ReadWriteOnce]
    size: 2Gi
  
  sidecar:
    datasources:
      enabled: true
      isDefaultDatasource: true
      uid: prometheus
    dashboards:
      enabled: true
      label: grafana_dashboard
      labelValue: "1"
  
  service:
    type: NodePort

# Disable components we don't need for load testing
alertmanager:
  enabled: false

nodeExporter:
  enabled: false  # Don't need node metrics for KWOK-based tests

kubeStateMetrics:
  enabled: true  # Keep this for pod/service state
